const cds = require('../../index'), { decodeURI } = cds.utils
cds.log().info('using legacy OData adapter')

const legacy_adapter4 = require('../../../libx/_runtime/cds-services/adapter/odata-v4/to')
const LOG = cds.log('okra')

module.exports = function ODataAdapter(srv) {
  const router = require('express').Router()

  router.use(function odata_log(req, _, next) {
    let url = decodeURI(req.originalUrl)
    LOG && LOG(req.method, url, req.body || '')
    if (/\$batch/.test(req.url))
      req.on('dispatch', req => {
        let path = decodeURI(req._.odataReq?._rawODataPath || '')
        LOG && LOG('>', req.event, path, req._queryOptions || '')
        if (LOG._debug && req.query) LOG.debug(req.query) //> why only for batch subrequests?
      })

    next()
  })
  router.use(legacy_adapter4(srv))
  return router
}
